---
# =============================================================================
# Block Malicious IPs - Cloudflare WAF + Nginx
# =============================================================================
# Este playbook configura proteção em duas camadas:
# 1. Cloudflare WAF - Bloqueia antes de chegar ao servidor (mais eficiente)
# 2. Nginx - Bloqueia caso passe pelo Cloudflare (backup)
#
# Uso:
#   export CLOUDFLARE_API_TOKEN="seu_token_aqui"
#   ansible-playbook -i inventory_frontend.yml block-malicious-ips.yml
#
# Ou passe como variável:
#   ansible-playbook -i inventory_frontend.yml block-malicious-ips.yml \
#     -e "cloudflare_api_token=seu_token"
# =============================================================================

- name: Block Malicious IPs on Cloudflare and Nginx
  hosts: frontend
  become: true

  vars:
    # Cloudflare credentials via environment variables
    # Export antes de rodar: export CLOUDFLARE_API_TOKEN="xxx" CLOUDFLARE_ZONE_ID="xxx"
    cloudflare_api_token: "{{ lookup('env', 'CLOUDFLARE_API_TOKEN') }}"
    cloudflare_zone_id: "{{ lookup('env', 'CLOUDFLARE_ZONE_ID') }}"

    # Lista de IPs maliciosos detectados em 08/Dec/2025
    # Atualizado em 09/Dec/2025 com IPs do alerta AWS CVE-2025-55182 (React2Shell)
    # Ref: https://aws.amazon.com/blogs/security/china-nexus-cyber-threat-groups-rapidly-exploit-react2shell-vulnerability-cve-2025-55182/
    blocked_ips:
      # === CVE-2025-55182 React2Shell Attackers ===
      - ip: "52.221.210.62"
        reason: "AWS Alert - CVE-2025-55182 React2Shell exploit - 05/Dec/2025"
      - ip: "206.237.3.150"
        reason: "Earth Lamia (China-nexus) - CVE-2025-55182 - 04/Dec/2025"
      - ip: "45.77.33.136"
        reason: "Jackpot Panda (China-nexus) - CVE-2025-55182 - 04/Dec/2025"
      - ip: "143.198.92.82"
        reason: "Anonymization Network - CVE-2025-55182 - 04/Dec/2025"
      - ip: "183.6.80.214"
        reason: "Unattributed China cluster - CVE-2025-55182 - 116 requests in 52min"
      # === Previous attackers ===
      - ip: "95.214.52.170"
        reason: "Scanner bot - 152 requests"
      - ip: "45.61.157.12"
        reason: "Suspicious POST requests"
      - ip: "128.14.227.179"
        reason: "Path traversal attack"
      - ip: "64.227.97.118"
        reason: "Path traversal attack"
      - ip: "47.99.150.111"
        reason: "Command injection attempt"
      - ip: "45.84.107.47"
        reason: "Python requests bot"
      - ip: "171.25.193.38"
        reason: "Python requests bot"
      - ip: "202.120.234.163"
        reason: "Assetnote scanner"
      - ip: "27.74.251.56"
        reason: "Assetnote scanner"
      - ip: "198.98.56.220"
        reason: "Assetnote scanner"
      - ip: "167.86.107.35"
        reason: "Suspicious minimal UA"

  tasks:
    # =========================================================================
    # CLOUDFLARE WAF - Block IPs at edge (runs locally, not on server)
    # =========================================================================
    - name: Validate Cloudflare credentials are set
      fail:
        msg: |
          Cloudflare credentials not set. Run:
          export CLOUDFLARE_API_TOKEN="your_token"
          export CLOUDFLARE_ZONE_ID="your_zone_id"
      when: cloudflare_api_token == "" or cloudflare_zone_id == ""
      delegate_to: localhost
      become: false
      run_once: true

    - name: Display IPs to be blocked on Cloudflare
      debug:
        msg: "Will block {{ blocked_ips | length }} IPs on Cloudflare WAF"
      delegate_to: localhost
      become: false
      run_once: true

    - name: Block malicious IPs on Cloudflare WAF
      uri:
        url: "https://api.cloudflare.com/client/v4/zones/{{ cloudflare_zone_id }}/firewall/access_rules/rules"
        method: POST
        headers:
          Authorization: "Bearer {{ cloudflare_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          mode: "block"
          configuration:
            target: "ip"
            value: "{{ item.ip }}"
          notes: "Ansible: {{ item.reason }}"
        status_code: [200, 409]  # 409 = already exists, which is ok
      loop: "{{ blocked_ips }}"
      delegate_to: localhost
      become: false
      run_once: true
      register: cloudflare_result
      ignore_errors: yes

    - name: Show Cloudflare blocking results
      debug:
        msg: "Blocked {{ item.item.ip }} - Status: {{ item.status | default('error') }}"
      loop: "{{ cloudflare_result.results }}"
      delegate_to: localhost
      become: false
      run_once: true
      when: cloudflare_result is defined

    # =========================================================================
    # NGINX - Backup protection on server
    # =========================================================================
    - name: Create nginx security directory
      file:
        path: /etc/nginx/security
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create blocked IPs configuration for Nginx
      copy:
        content: |
          # Blocked Malicious IPs
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}
          # These IPs are also blocked on Cloudflare WAF
          #
          # To add more IPs, update the ansible playbook and re-run:
          # ansible-playbook -i inventory_frontend.yml block-malicious-ips.yml

          {% for item in blocked_ips %}
          # {{ item.reason }}
          deny {{ item.ip }};
          {% endfor %}
        dest: /etc/nginx/security/blocked-ips.conf
        owner: root
        group: root
        mode: '0644'
      notify: Reload Nginx

    - name: Create rate limiting configuration
      copy:
        content: |
          # Rate Limiting Configuration
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}

          # Define rate limit zones
          limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
          limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
          limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;

          # Limit connections per IP
          limit_conn_zone $binary_remote_addr zone=addr:10m;
        dest: /etc/nginx/security/rate-limiting.conf
        owner: root
        group: root
        mode: '0644'
      notify: Reload Nginx

    - name: Create security headers configuration
      copy:
        content: |
          # Security Configuration
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}

          # Block common attack patterns in URI
          # Note: These are location blocks, must be inside server block
        dest: /etc/nginx/security/security-notes.conf
        owner: root
        group: root
        mode: '0644'

    - name: Update main nginx.conf to include security configs
      lineinfile:
        path: /etc/nginx/nginx.conf
        line: "    include /etc/nginx/security/rate-limiting.conf;"
        insertafter: "http {"
        state: present
      notify: Reload Nginx

    - name: Update HTTP site config to include blocked IPs and security
      blockinfile:
        path: /etc/nginx/sites-available/portalrevalida.com
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Security"
        insertafter: "server {"
        block: |
              # Include blocked IPs
              include /etc/nginx/security/blocked-ips.conf;

              # Rate limiting
              limit_req zone=general burst=20 nodelay;
              limit_conn addr 10;

              # Block common attack patterns
              location ~* "(base64_encode|base64_decode|eval\(|exec\()" {
                  return 403;
              }

              # Block access to sensitive files
              location ~* "\.(env|git|htaccess|htpasswd|ini|log|sh|sql|bak)$" {
                  deny all;
                  return 404;
              }

              # Block WordPress/PHP attacks (we don't use PHP)
              location ~* "(wp-admin|wp-login|xmlrpc\.php|\.php)" {
                  return 404;
              }

              # Block path traversal attempts
              location ~* "(\.\./|\.\.\\\\)" {
                  return 403;
              }
      notify: Reload Nginx

    - name: Update HTTPS site config to include blocked IPs and security
      blockinfile:
        path: /etc/nginx/sites-available/portalrevalida.com-ssl
        marker: "# {mark} ANSIBLE MANAGED BLOCK - Security"
        insertafter: "server {"
        block: |
              # Include blocked IPs
              include /etc/nginx/security/blocked-ips.conf;

              # Rate limiting
              limit_req zone=general burst=20 nodelay;
              limit_conn addr 10;

              # Block common attack patterns
              location ~* "(base64_encode|base64_decode|eval\(|exec\()" {
                  return 403;
              }

              # Block access to sensitive files
              location ~* "\.(env|git|htaccess|htpasswd|ini|log|sh|sql|bak)$" {
                  deny all;
                  return 404;
              }

              # Block WordPress/PHP attacks (we don't use PHP)
              location ~* "(wp-admin|wp-login|xmlrpc\.php|\.php)" {
                  return 404;
              }

              # Block path traversal attempts
              location ~* "(\.\./|\.\.\\\\)" {
                  return 403;
              }
      notify: Reload Nginx

    - name: Test Nginx configuration
      command: nginx -t
      register: nginx_test
      changed_when: false

    - name: Show Nginx test result
      debug:
        var: nginx_test.stderr_lines

    # =========================================================================
    # SUMMARY
    # =========================================================================
    - name: Display summary
      debug:
        msg: |
          ✅ Security configuration complete!

          Cloudflare WAF:
          - {{ blocked_ips | length }} IPs blocked at edge

          Nginx:
          - Blocked IPs config: /etc/nginx/security/blocked-ips.conf
          - Rate limiting enabled
          - Attack patterns blocked

          To add new IPs:
          1. Edit this playbook and add to blocked_ips list
          2. Re-run: ansible-playbook -i inventory_frontend.yml block-malicious-ips.yml

  handlers:
    - name: Reload Nginx
      systemd:
        name: nginx
        state: reloaded
