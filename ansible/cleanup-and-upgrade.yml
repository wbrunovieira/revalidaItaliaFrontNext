---
- name: Cleanup Disk Space and Upgrade Node.js
  hosts: frontend
  become: true

  tasks:
    - name: "ðŸ“Š DISK - Verificando espaÃ§o em disco antes"
      shell: df -h /
      register: disk_before

    - name: "ðŸ“Š DISK - EspaÃ§o disponÃ­vel ANTES"
      debug:
        var: disk_before.stdout_lines

    - name: "ðŸ§¹ CLEANUP - Limpando cache do APT"
      apt:
        autoclean: yes
        autoremove: yes

    - name: "ðŸ§¹ CLEANUP - Removendo pacotes Ã³rfÃ£os"
      shell: apt-get autoremove -y && apt-get clean

    - name: "ðŸ§¹ NPM - Limpando cache npm global"
      shell: npm cache clean --force
      become_user: ubuntu
      ignore_errors: yes

    - name: "ðŸ§¹ PM2 - Limpando logs do PM2"
      shell: pm2 flush
      become_user: ubuntu
      ignore_errors: yes

    - name: "ðŸ§¹ LOGS - Removendo logs antigos do sistema"
      shell: |
        journalctl --vacuum-time=7d
        find /var/log -type f -name "*.log" -mtime +7 -delete
        find /var/log -type f -name "*.gz" -delete
      ignore_errors: yes

    - name: "ðŸ§¹ TMP - Limpando diretÃ³rio temporÃ¡rio"
      shell: |
        rm -rf /tmp/*
        rm -rf /var/tmp/*
      ignore_errors: yes

    - name: "ðŸ§¹ NPM - Removendo node_modules antigo"
      shell: rm -rf /home/ubuntu/frontend/node_modules
      become_user: ubuntu
      ignore_errors: yes

    - name: "ðŸ§¹ BUILD - Removendo .next antigo"
      shell: rm -rf /home/ubuntu/frontend/.next
      become_user: ubuntu
      ignore_errors: yes

    - name: "ðŸ“Š DISK - Verificando espaÃ§o apÃ³s limpeza"
      shell: df -h /
      register: disk_after_clean

    - name: "ðŸ“Š DISK - EspaÃ§o disponÃ­vel APÃ“S LIMPEZA"
      debug:
        var: disk_after_clean.stdout_lines

    - name: "ðŸ“¦ NODE - Removendo Node.js antigo"
      apt:
        name:
          - nodejs
          - npm
        state: absent
        purge: yes

    - name: "ðŸ“¥ NODE - Instalando NodeSource repository (Node.js 20.x LTS)"
      shell: |
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
      args:
        warn: false

    - name: "ðŸ“¦ NODE - Instalando Node.js 20.x"
      apt:
        name: nodejs
        state: present
        update_cache: yes

    - name: "âœ… NODE - Verificando versÃ£o instalada"
      shell: node --version && npm --version
      register: node_version

    - name: "âœ… NODE - VersÃµes instaladas"
      debug:
        var: node_version.stdout_lines

    - name: "ðŸ“Š DISK - EspaÃ§o final disponÃ­vel"
      shell: df -h /
      register: disk_final

    - name: "ðŸ“Š DISK - EspaÃ§o disponÃ­vel FINAL"
      debug:
        var: disk_final.stdout_lines

    - name: "âœ… SUCESSO - Limpeza e atualizaÃ§Ã£o concluÃ­das!"
      debug:
        msg:
          - "ðŸŽ‰ Servidor limpo e Node.js atualizado com sucesso!"
          - "Agora vocÃª pode executar o quick-deploy.yml novamente"
