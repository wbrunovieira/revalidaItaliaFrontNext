---
# configure-safe-updates.yml
# Configura atualiza√ß√µes autom√°ticas de forma segura para produ√ß√£o
#
# O que faz:
# - Configura apenas atualiza√ß√µes de SEGURAN√áA (n√£o todas)
# - Define hor√°rio fixo: Domingo √†s 04:00 UTC
# - Desabilita reboot autom√°tico
# - Desabilita rein√≠cio autom√°tico de servi√ßos
# - Cria script para verificar updates pendentes
#
# Uso: ansible-playbook -i inventory_frontend.yml configure-safe-updates.yml
#
# Problema que resolve:
# O apt-daily-upgrade causou "systemd Reexecuting" que parou todos os servi√ßos
# simultaneamente, incluindo o DNS (systemd-resolved), fazendo o Nginx falhar
# ao tentar resolver o upstream S3.

- name: Configure Safe Automatic Updates for Production
  hosts: frontend
  become: true

  vars:
    # Hor√°rio das atualiza√ß√µes (UTC)
    update_hour: "04"
    update_minute: "00"
    update_day: "Sun"  # Domingo

    # Email para notifica√ß√µes (opcional - deixe vazio para desabilitar)
    admin_email: ""

  tasks:
    # =========================================================================
    # BACKUP DAS CONFIGURA√á√ïES ATUAIS
    # =========================================================================
    - name: Create backup directory
      file:
        path: /root/apt-config-backup
        state: directory
        mode: '0700'

    - name: Backup current unattended-upgrades config
      copy:
        src: /etc/apt/apt.conf.d/50unattended-upgrades
        dest: /root/apt-config-backup/50unattended-upgrades.bak.{{ ansible_date_time.epoch }}
        remote_src: yes
      ignore_errors: yes

    # =========================================================================
    # INSTALAR PACOTES NECESS√ÅRIOS
    # =========================================================================
    - name: Ensure unattended-upgrades is installed
      apt:
        name:
          - unattended-upgrades
          - apt-listchanges
        state: present
        update_cache: yes

    # =========================================================================
    # CONFIGURAR UNATTENDED-UPGRADES (APENAS SEGURAN√áA)
    # =========================================================================
    - name: Configure unattended-upgrades for security only
      copy:
        content: |
          // Configura√ß√£o segura para produ√ß√£o - Gerado por Ansible
          // Data: {{ ansible_date_time.iso8601 }}

          // APENAS atualiza√ß√µes de seguran√ßa (N√ÉO updates gerais)
          Unattended-Upgrade::Allowed-Origins {
              "${distro_id}:${distro_codename}-security";
              "${distro_id}ESMApps:${distro_codename}-apps-security";
              "${distro_id}ESM:${distro_codename}-infra-security";
              // "${distro_id}:${distro_codename}-updates";  // DESABILITADO
          };

          // Pacotes para NUNCA atualizar automaticamente (cr√≠ticos)
          Unattended-Upgrade::Package-Blacklist {
              "nginx";
              "nodejs";
              "npm";
              "docker-ce";
              "docker-ce-cli";
              "containerd.io";
          };

          // N√ÉO reiniciar automaticamente (CR√çTICO para produ√ß√£o)
          Unattended-Upgrade::Automatic-Reboot "false";

          // Se fosse reiniciar, seria neste hor√°rio (mas est√° desabilitado)
          Unattended-Upgrade::Automatic-Reboot-Time "04:00";

          // N√ÉO reiniciar servi√ßos automaticamente durante upgrade
          Unattended-Upgrade::InstallOnShutdown "false";

          // Remover depend√™ncias n√£o utilizadas
          Unattended-Upgrade::Remove-Unused-Dependencies "true";
          Unattended-Upgrade::Remove-New-Unused-Dependencies "true";

          // Remover kernels antigos n√£o utilizados
          Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";

          // Logging detalhado
          Unattended-Upgrade::SyslogEnable "true";
          Unattended-Upgrade::SyslogFacility "daemon";

          // Baixar mas N√ÉO instalar automaticamente (mais seguro)
          // Descomente a linha abaixo para modo ultra-seguro
          // Unattended-Upgrade::Download-Only "true";

          {% if admin_email %}
          // Enviar email apenas em caso de erro
          Unattended-Upgrade::Mail "{{ admin_email }}";
          Unattended-Upgrade::MailReport "only-on-error";
          {% endif %}

          // Limitar banda para n√£o impactar produ√ß√£o
          Acquire::http::Dl-Limit "1000";

          // N√£o atualizar se houver usu√°rios logados (opcional)
          // Unattended-Upgrade::Skip-Updates-On-Metered-Connections "true";
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        owner: root
        group: root
        mode: '0644'
      notify: Restart unattended-upgrades

    # =========================================================================
    # CONFIGURAR PERIODICIDADE
    # =========================================================================
    - name: Configure APT periodic settings
      copy:
        content: |
          // Configura√ß√£o de periodicidade - Gerado por Ansible

          // Atualizar lista de pacotes diariamente
          APT::Periodic::Update-Package-Lists "1";

          // Baixar atualiza√ß√µes diariamente (mas n√£o instalar)
          APT::Periodic::Download-Upgradeable-Packages "1";

          // Executar unattended-upgrade diariamente (apenas seguran√ßa)
          APT::Periodic::Unattended-Upgrade "1";

          // Limpar cache de pacotes a cada 7 dias
          APT::Periodic::AutocleanInterval "7";

          // Verbose logging
          APT::Periodic::Verbose "1";
        dest: /etc/apt/apt.conf.d/10periodic
        owner: root
        group: root
        mode: '0644'

    # =========================================================================
    # CONFIGURAR TIMER PARA HOR√ÅRIO ESPEC√çFICO
    # =========================================================================
    - name: Create custom apt-daily-upgrade timer override directory
      file:
        path: /etc/systemd/system/apt-daily-upgrade.timer.d
        state: directory
        mode: '0755'

    - name: Configure apt-daily-upgrade timer for specific time (Sunday 4AM)
      copy:
        content: |
          # Override para executar apenas no domingo √†s 04:00 UTC
          # Gerado por Ansible
          [Timer]
          OnCalendar=
          OnCalendar={{ update_day }} *-*-* {{ update_hour }}:{{ update_minute }}
          RandomizedDelaySec=0
          Persistent=true
        dest: /etc/systemd/system/apt-daily-upgrade.timer.d/override.conf
        owner: root
        group: root
        mode: '0644'
      notify: Reload systemd

    - name: Create custom apt-daily timer override directory
      file:
        path: /etc/systemd/system/apt-daily.timer.d
        state: directory
        mode: '0755'

    - name: Configure apt-daily timer for early morning
      copy:
        content: |
          # Override para executar √†s 03:00 UTC (antes do upgrade)
          # Gerado por Ansible
          [Timer]
          OnCalendar=
          OnCalendar=*-*-* 03:00
          RandomizedDelaySec=0
          Persistent=true
        dest: /etc/systemd/system/apt-daily.timer.d/override.conf
        owner: root
        group: root
        mode: '0644'
      notify: Reload systemd

    # =========================================================================
    # DESABILITAR NEEDRESTART AUTOM√ÅTICO (evita rein√≠cio de servi√ßos)
    # =========================================================================
    - name: Check if needrestart is installed
      stat:
        path: /etc/needrestart/needrestart.conf
      register: needrestart_config

    - name: Configure needrestart to not restart services automatically
      lineinfile:
        path: /etc/needrestart/needrestart.conf
        regexp: '^\$nrconf\{restart\}'
        line: "$nrconf{restart} = 'l';"  # 'l' = list only, don't restart
        backup: yes
      when: needrestart_config.stat.exists

    # =========================================================================
    # CRIAR SCRIPT DE VERIFICA√á√ÉO DE UPDATES
    # =========================================================================
    - name: Create script to check pending updates
      copy:
        content: |
          #!/bin/bash
          # check-updates.sh - Verifica atualiza√ß√µes pendentes
          # Gerado por Ansible

          echo "=========================================="
          echo "  Verifica√ß√£o de Atualiza√ß√µes Pendentes"
          echo "  Data: $(date)"
          echo "=========================================="
          echo ""

          # Atualizar lista de pacotes
          apt-get update -qq

          # Verificar atualiza√ß√µes de seguran√ßa
          echo "üîí Atualiza√ß√µes de SEGURAN√áA pendentes:"
          apt-get -s dist-upgrade | grep "^Inst" | grep -i security || echo "   Nenhuma"
          echo ""

          # Verificar todas as atualiza√ß√µes
          echo "üì¶ TODAS as atualiza√ß√µes pendentes:"
          apt list --upgradable 2>/dev/null | tail -n +2 || echo "   Nenhuma"
          echo ""

          # Verificar se reboot √© necess√°rio
          if [ -f /var/run/reboot-required ]; then
              echo "‚ö†Ô∏è  ATEN√á√ÉO: Reboot pendente!"
              cat /var/run/reboot-required.pkgs 2>/dev/null
          else
              echo "‚úÖ Nenhum reboot pendente"
          fi
          echo ""

          # Verificar √∫ltimo upgrade
          echo "üìÖ √öltimo unattended-upgrade:"
          grep "Packages that will be upgraded" /var/log/unattended-upgrades/unattended-upgrades.log 2>/dev/null | tail -3 || echo "   Sem registros"
          echo ""

          # Status dos timers
          echo "‚è∞ Status dos timers APT:"
          systemctl list-timers apt-daily apt-daily-upgrade --no-pager
          echo ""

          echo "=========================================="
        dest: /usr/local/bin/check-updates
        owner: root
        group: root
        mode: '0755'

    # =========================================================================
    # CRIAR SCRIPT DE UPDATE MANUAL SEGURO
    # =========================================================================
    - name: Create safe manual update script
      copy:
        content: |
          #!/bin/bash
          # safe-update.sh - Atualiza√ß√£o manual segura para produ√ß√£o
          # Gerado por Ansible

          set -e

          echo "=========================================="
          echo "  Atualiza√ß√£o Manual Segura"
          echo "  Data: $(date)"
          echo "=========================================="
          echo ""

          # Verificar se √© root
          if [ "$EUID" -ne 0 ]; then
              echo "‚ùå Execute como root: sudo $0"
              exit 1
          fi

          # Mostrar o que ser√° atualizado
          echo "üìã Verificando atualiza√ß√µes dispon√≠veis..."
          apt-get update -qq

          UPDATES=$(apt list --upgradable 2>/dev/null | tail -n +2)
          if [ -z "$UPDATES" ]; then
              echo "‚úÖ Sistema j√° est√° atualizado!"
              exit 0
          fi

          echo ""
          echo "Pacotes a serem atualizados:"
          echo "$UPDATES"
          echo ""

          # Confirmar
          read -p "Deseja continuar? (s/N): " confirm
          if [ "$confirm" != "s" ] && [ "$confirm" != "S" ]; then
              echo "Cancelado."
              exit 0
          fi

          # Fazer backup do estado dos servi√ßos
          echo ""
          echo "üì∏ Salvando estado dos servi√ßos..."
          systemctl list-units --type=service --state=running > /tmp/services-before-update.txt

          # Executar atualiza√ß√£o
          echo ""
          echo "üîÑ Executando atualiza√ß√£o..."
          apt-get upgrade -y

          # Verificar servi√ßos
          echo ""
          echo "üîç Verificando servi√ßos cr√≠ticos..."

          for service in nginx pm2-ubuntu; do
              if systemctl is-active --quiet $service 2>/dev/null; then
                  echo "   ‚úÖ $service: running"
              else
                  echo "   ‚ùå $service: NOT RUNNING - tentando reiniciar..."
                  systemctl start $service || true
              fi
          done

          # Verificar se reboot √© necess√°rio
          echo ""
          if [ -f /var/run/reboot-required ]; then
              echo "‚ö†Ô∏è  ATEN√á√ÉO: Reboot necess√°rio para completar atualiza√ß√£o"
              echo "   Pacotes que requerem reboot:"
              cat /var/run/reboot-required.pkgs 2>/dev/null
              echo ""
              echo "   Execute 'sudo reboot' quando poss√≠vel"
          else
              echo "‚úÖ Atualiza√ß√£o completa! Nenhum reboot necess√°rio."
          fi

          echo ""
          echo "=========================================="
        dest: /usr/local/bin/safe-update
        owner: root
        group: root
        mode: '0755'

    # =========================================================================
    # RECARREGAR CONFIGURA√á√ïES
    # =========================================================================
    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Restart apt-daily timer
      systemd:
        name: apt-daily.timer
        state: restarted
        enabled: yes

    - name: Restart apt-daily-upgrade timer
      systemd:
        name: apt-daily-upgrade.timer
        state: restarted
        enabled: yes

    # =========================================================================
    # VERIFICA√á√ÉO FINAL
    # =========================================================================
    - name: Show timer configuration
      command: systemctl list-timers apt-daily apt-daily-upgrade --no-pager
      register: timer_status
      changed_when: false

    - name: Display timer status
      debug:
        msg: "{{ timer_status.stdout_lines }}"

    - name: Show unattended-upgrades configuration summary
      shell: |
        echo "=== Configura√ß√£o Atual ==="
        echo ""
        echo "Origens permitidas:"
        grep -A5 "Allowed-Origins" /etc/apt/apt.conf.d/50unattended-upgrades | head -10
        echo ""
        echo "Pacotes bloqueados:"
        grep -A10 "Package-Blacklist" /etc/apt/apt.conf.d/50unattended-upgrades | head -12
        echo ""
        echo "Reboot autom√°tico:"
        grep "Automatic-Reboot" /etc/apt/apt.conf.d/50unattended-upgrades
      register: config_summary
      changed_when: false

    - name: Display configuration summary
      debug:
        msg: "{{ config_summary.stdout_lines }}"

    - name: Final instructions
      debug:
        msg:
          - "=========================================="
          - "‚úÖ Configura√ß√£o de atualiza√ß√µes seguras aplicada!"
          - ""
          - "üìÖ Atualiza√ß√µes de SEGURAN√áA ser√£o aplicadas:"
          - "   - Dia: Domingo"
          - "   - Hor√°rio: 04:00 UTC (01:00 Bras√≠lia)"
          - ""
          - "üõ°Ô∏è Prote√ß√µes ativadas:"
          - "   - Apenas patches de seguran√ßa"
          - "   - nginx, nodejs, npm bloqueados"
          - "   - Reboot autom√°tico DESABILITADO"
          - "   - Rein√≠cio de servi√ßos DESABILITADO"
          - ""
          - "üìã Comandos √∫teis:"
          - "   - Verificar updates: sudo check-updates"
          - "   - Update manual: sudo safe-update"
          - ""
          - "=========================================="

  handlers:
    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Restart unattended-upgrades
      systemd:
        name: unattended-upgrades
        state: restarted
