---
# Play 1: Sync local public/ to S3 (roda na m√°quina local)
- name: Sync Local Assets to S3
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    aws_region: us-east-2
    s3_bucket_name: revalida-documents-891ff933
    local_public_dir: "{{ playbook_dir }}/../public"

  tasks:
    - name: "‚òÅÔ∏è S3 SYNC - Sincronizando assets locais para S3"
      shell: |
        aws s3 sync "{{ local_public_dir }}/" s3://{{ s3_bucket_name }}/public/ \
          --region {{ aws_region }} \
          --profile bruno-admin-revalida-aws \
          --exclude ".git/*" \
          --exclude "*.md" \
          --exclude ".gitkeep" \
          --cache-control "public, max-age=86400" \
          --metadata-directive REPLACE
      register: s3_sync_result

    - name: "‚úÖ S3 - Resultado da sincroniza√ß√£o"
      debug:
        msg:
          - "Assets sincronizados para s3://{{ s3_bucket_name }}/public/"
          - "{{ s3_sync_result.stdout_lines | default(['Nenhuma mudan√ßa']) }}"

# Play 2: Deploy no servidor (sem baixar public/)
- name: Quick Deploy - Update Code and Restart
  hosts: frontend
  become: true

  vars:
    app_dir: /home/ubuntu/frontend
    repo_url: https://github.com/wbrunovieira/revalidaItaliaFrontNext.git
    aws_region: us-east-2
    s3_bucket_name: revalida-documents-891ff933
    s3_public_url: "https://{{ s3_bucket_name }}.s3.{{ aws_region }}.amazonaws.com/public"

  tasks:
    - name: "üîÑ INICIANDO - Atualiza√ß√£o do c√≥digo frontend"
      debug:
        msg: "Iniciando processo de atualiza√ß√£o do c√≥digo em {{ app_dir }}"

    - name: "‚öôÔ∏è GIT - Configurando sparse-checkout para excluir public/models/"
      shell: |
        cd {{ app_dir }}
        git config core.sparseCheckout true
        mkdir -p .git/info
        cat > .git/info/sparse-checkout << 'EOF'
        /*
        !/public/models/
        EOF
      become_user: ubuntu
      ignore_errors: yes

    - name: "üíæ BACKUP - Salvando .env.local antes do git reset"
      shell: |
        cd {{ app_dir }}
        if [ -f .env.local ]; then
          cp .env.local /tmp/.env.local.backup
          echo "Backup criado"
        else
          echo "Arquivo .env.local n√£o existe"
        fi
      become_user: ubuntu
      register: env_backup

    - name: "üì• GIT FETCH - Buscando atualiza√ß√µes"
      shell: |
        cd {{ app_dir }}
        git fetch origin main
      become_user: ubuntu
      register: git_fetch

    - name: "üì• GIT RESET - Aplicando atualiza√ß√µes (exceto public/)"
      shell: |
        cd {{ app_dir }}
        git reset --hard origin/main
      become_user: ubuntu
      register: git_result

    - name: "‚ôªÔ∏è RESTORE - Restaurando .env.local ap√≥s git reset"
      shell: |
        cd {{ app_dir }}
        if [ -f /tmp/.env.local.backup ]; then
          cp /tmp/.env.local.backup .env.local
          rm /tmp/.env.local.backup
          echo "Restaurado com sucesso"
        else
          echo "Nenhum backup para restaurar"
        fi
      become_user: ubuntu
      register: env_restore

    - name: "üîß ENV - Garantindo vari√°veis S3 no .env.local"
      shell: |
        cd {{ app_dir }}
        # Remove vari√°veis S3 antigas (se existirem com valores incorretos)
        sed -i '/^S3_BUCKET=/d' .env.local 2>/dev/null || true
        sed -i '/^AWS_REGION=/d' .env.local 2>/dev/null || true
        sed -i '/^NODE_ENV=/d' .env.local 2>/dev/null || true
        sed -i '/^CDN_URL=/d' .env.local 2>/dev/null || true
        # Adiciona vari√°veis S3 corretas
        echo "" >> .env.local
        echo "# S3 Storage Configuration (auto-added by quick-deploy)" >> .env.local
        echo "S3_BUCKET={{ s3_bucket_name }}" >> .env.local
        echo "AWS_REGION={{ aws_region }}" >> .env.local
        echo "CDN_URL=https://{{ s3_bucket_name }}.s3.{{ aws_region }}.amazonaws.com" >> .env.local
        echo "NODE_ENV=production" >> .env.local
      become_user: ubuntu
      register: env_s3_update

    - name: "‚úÖ ENV - Vari√°veis S3 configuradas"
      debug:
        msg: "Vari√°veis S3_BUCKET, AWS_REGION, CDN_URL e NODE_ENV adicionadas ao .env.local"

    - name: "‚úÖ GIT - C√≥digo atualizado"
      debug:
        msg: "Git atualizado com sucesso (public/ ignorado via sparse-checkout)"

    - name: "üßπ DISK - Limpando espa√ßo em disco antes do build"
      shell: |
        # Limpar logs do journal (manter s√≥ 3 dias)
        journalctl --vacuum-time=3d 2>/dev/null || true
        # Limpar cache do apt
        apt clean 2>/dev/null || true
        apt autoclean 2>/dev/null || true
        # Limpar logs antigos de login
        truncate -s 0 /var/log/btmp.1 2>/dev/null || true
        truncate -s 0 /var/log/wtmp.1 2>/dev/null || true
        # Limpar snaps antigos (vers√µes desabilitadas)
        snap list --all 2>/dev/null | awk '/disabled/{print $1, $3}' | while read snapname revision; do
          snap remove "$snapname" --revision="$revision" 2>/dev/null || true
        done
        # Limpar cache do npm global
        npm cache clean --force 2>/dev/null || true
        # Mostrar espa√ßo dispon√≠vel
        df -h / | tail -1
      register: disk_cleanup
      ignore_errors: yes

    - name: "‚úÖ DISK - Espa√ßo em disco ap√≥s limpeza"
      debug:
        msg: "{{ disk_cleanup.stdout_lines | default(['Limpeza conclu√≠da']) }}"

    - name: "üì¶ NPM - Instalando depend√™ncias"
      command: npm install
      args:
        chdir: '{{ app_dir }}'
      become_user: ubuntu
      register: npm_install

    - name: "üßπ LIMPEZA - Removendo cache do Next.js (.next)"
      file:
        path: '{{ app_dir }}/.next'
        state: absent
      become_user: ubuntu

    - name: "‚úÖ CACHE - Cache do Next.js removido"
      debug:
        msg: "Pasta .next removida para garantir build limpo"

    - name: "üî® BUILD - Compilando aplica√ß√£o Next.js"
      command: npm run build
      args:
        chdir: '{{ app_dir }}'
      become_user: ubuntu
      register: build_result

    - name: "‚úÖ BUILD - Status da compila√ß√£o"
      debug:
        msg: "Build conclu√≠do com sucesso!"

    - name: "üåê NGINX - Atualizando configura√ß√£o para servir /public/ do S3"
      copy:
        content: |
          server {
              listen 443 ssl http2;
              listen [::]:443 ssl http2;
              server_name portalrevalida.com www.portalrevalida.com;

              # SSL Configuration
              ssl_certificate /etc/nginx/ssl/portalrevalida.com.crt;
              ssl_certificate_key /etc/nginx/ssl/portalrevalida.com.key;

              # SSL Security Settings
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers HIGH:!aNULL:!MD5;
              ssl_prefer_server_ciphers on;

              # Security headers
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header Referrer-Policy "no-referrer-when-downgrade" always;

              # Cloudflare Real IP
              set_real_ip_from 173.245.48.0/20;
              set_real_ip_from 103.21.244.0/22;
              set_real_ip_from 103.22.200.0/22;
              set_real_ip_from 103.31.4.0/22;
              set_real_ip_from 141.101.64.0/18;
              set_real_ip_from 108.162.192.0/18;
              set_real_ip_from 190.93.240.0/20;
              set_real_ip_from 188.114.96.0/20;
              set_real_ip_from 197.234.240.0/22;
              set_real_ip_from 198.41.128.0/17;
              set_real_ip_from 162.158.0.0/15;
              set_real_ip_from 104.16.0.0/13;
              set_real_ip_from 104.24.0.0/14;
              set_real_ip_from 172.64.0.0/13;
              set_real_ip_from 131.0.72.0/22;
              real_ip_header CF-Connecting-IP;

              # Proxy para assets p√∫blicos do S3
              location /public/ {
                  proxy_pass https://{{ s3_bucket_name }}.s3.{{ aws_region }}.amazonaws.com/public/;
                  proxy_http_version 1.1;
                  proxy_set_header Host {{ s3_bucket_name }}.s3.{{ aws_region }}.amazonaws.com;
                  proxy_cache_valid 200 7d;
                  proxy_cache_valid 404 1m;
                  expires 7d;
                  add_header Cache-Control "public, immutable";
              }

              # Proxy para Next.js (aplica√ß√£o)
              location / {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;

                  # Timeouts
                  proxy_connect_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;

                  # Buffer settings
                  proxy_buffering off;
                  proxy_buffer_size 4k;
                  proxy_buffers 8 4k;
                  proxy_busy_buffers_size 8k;

                  # Max body size
                  client_max_body_size 50M;
              }
          }
        dest: /etc/nginx/sites-available/portalrevalida.com-ssl
        owner: root
        group: root
        mode: '0644'
      register: nginx_config

    - name: "üîÑ NGINX - Testando configura√ß√£o"
      command: nginx -t
      register: nginx_test
      changed_when: false

    - name: "üîÑ NGINX - Recarregando"
      systemd:
        name: nginx
        state: reloaded
      when: nginx_config.changed

    - name: "üîÑ PM2 - Reiniciando aplica√ß√£o"
      shell: |
        pm2 restart frontend || pm2 start npm --name frontend -- start -- -p 3000 -H 0.0.0.0
        pm2 save
      args:
        chdir: '{{ app_dir }}'
      become_user: ubuntu
      register: pm2_result

    - name: "‚è≥ AGUARDANDO - Esperando aplica√ß√£o iniciar (15s)"
      pause:
        seconds: 15

    - name: "üìä PM2 - Verificando status da aplica√ß√£o"
      shell: pm2 status
      become_user: ubuntu
      register: pm2_status

    - name: "‚úÖ STATUS - Mostrando status do PM2"
      debug:
        var: pm2_status.stdout_lines

    - name: "‚úÖ SUCESSO - Deploy conclu√≠do!"
      debug:
        msg:
          - "üéâ Atualiza√ß√£o conclu√≠da com sucesso!"
          - "üì¶ Assets p√∫blicos servidos de: {{ s3_public_url }}"
          - "üåê Aplica√ß√£o rodando em: https://portalrevalida.com"
