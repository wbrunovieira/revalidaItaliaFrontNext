---
- name: Quick Deploy - Update Code and Restart
  hosts: frontend
  become: true

  vars:
    app_dir: /home/ubuntu/frontend
    repo_url: https://github.com/wbrunovieira/revalidaItaliaFrontNext.git
    aws_region: us-east-2
    s3_bucket_name: revalida-documents-891ff933

  tasks:
    - name: "ğŸ”„ INICIANDO - AtualizaÃ§Ã£o do cÃ³digo frontend"
      debug:
        msg: "Iniciando processo de atualizaÃ§Ã£o do cÃ³digo em {{ app_dir }}"

    - name: "ğŸ“¥ GIT PULL - Atualizando cÃ³digo do repositÃ³rio"
      git:
        repo: '{{ repo_url }}'
        dest: '{{ app_dir }}'
        version: main
        force: yes
        update: yes
      become_user: ubuntu
      register: git_result

    - name: "âœ… GIT - Mostrar mudanÃ§as obtidas"
      debug:
        msg:
          - "Git pull concluÃ­do!"
          - "Antes: {{ git_result.before | default('unknown') }}"
          - "Depois: {{ git_result.after | default('unknown') }}"

    - name: "ğŸ“¦ NPM - Instalando dependÃªncias"
      command: npm install
      args:
        chdir: '{{ app_dir }}'
      become_user: ubuntu
      register: npm_install

    - name: "ğŸ§¹ LIMPEZA - Removendo cache do Next.js (.next)"
      file:
        path: '{{ app_dir }}/.next'
        state: absent
      become_user: ubuntu

    - name: "âœ… CACHE - Cache do Next.js removido"
      debug:
        msg: "Pasta .next removida para garantir build limpo"

    - name: "ğŸ”¨ BUILD - Compilando aplicaÃ§Ã£o Next.js"
      command: npm run build
      args:
        chdir: '{{ app_dir }}'
      become_user: ubuntu
      register: build_result

    - name: "âœ… BUILD - Status da compilaÃ§Ã£o"
      debug:
        msg: "Build concluÃ­do com sucesso!"

    - name: "â˜ï¸ S3 SYNC - Sincronizando assets pÃºblicos para S3"
      shell: |
        aws s3 sync {{ app_dir }}/public/ s3://{{ s3_bucket_name }}/public/ \
          --region {{ aws_region }} \
          --delete \
          --exclude ".git/*" \
          --exclude "*.md" \
          --cache-control "public, max-age=86400" \
          --metadata-directive REPLACE
      environment:
        AWS_REGION: "{{ aws_region }}"
      become_user: ubuntu
      register: s3_sync_result

    - name: "âœ… S3 - Assets sincronizados"
      debug:
        msg: "Assets pÃºblicos atualizados em s3://{{ s3_bucket_name }}/public/"

    - name: "ğŸ”„ PM2 - Reiniciando aplicaÃ§Ã£o"
      shell: |
        pm2 restart frontend || pm2 start npm --name frontend -- start -- -p 3000 -H 0.0.0.0
        pm2 save
      args:
        chdir: '{{ app_dir }}'
      become_user: ubuntu
      register: pm2_result

    - name: "â³ AGUARDANDO - Esperando aplicaÃ§Ã£o iniciar (15s)"
      pause:
        seconds: 15

    - name: "ğŸ“Š PM2 - Verificando status da aplicaÃ§Ã£o"
      shell: pm2 status
      become_user: ubuntu
      register: pm2_status

    - name: "âœ… STATUS - Mostrando status do PM2"
      debug:
        var: pm2_status.stdout_lines

    - name: "âœ… SUCESSO - Deploy concluÃ­do!"
      debug:
        msg:
          - "ğŸ‰ AtualizaÃ§Ã£o concluÃ­da com sucesso!"
          - "AplicaÃ§Ã£o rodando em: http://portalrevalida.com"
