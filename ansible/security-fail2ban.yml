---
# =============================================================================
# Security - Fail2Ban Auto-Protection
# =============================================================================
# Este playbook instala e configura fail2ban para bloquear automaticamente
# IPs que tentam atacar o servidor baseado em padr√µes nos logs do nginx.
#
# Uso:
#   ansible-playbook -i inventory_frontend.yml security-fail2ban.yml
#
# Jails ativos (12 total):
#   - sshd: SSH brute force (maxretry=3)
#   - nginx-pathtraversal: Path traversal (ban 7 dias)
#   - nginx-sqli: SQL injection (ban 7 dias)
#   - nginx-noscript: PHP/WordPress attacks
#   - nginx-botsearch: .env/.git access
#   - nginx-badbots: Malicious user agents
#   - nginx-postflood: POST flood attacks
#   - nginx-probe: HTTP method probes
#   - nginx-login: Login brute force
#   - nginx-sensitive-files: Config file access
#   - nginx-req-limit: Rate limit abuse
#   - nginx-http-auth: Auth failures
# =============================================================================

- name: Install and Configure Fail2Ban Security
  hosts: frontend
  become: true

  vars:
    bantime: 86400
    findtime: 600
    maxretry: 3

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install fail2ban
      apt:
        name: fail2ban
        state: present

    - name: Create fail2ban jail.local configuration
      copy:
        content: |
          [DEFAULT]
          bantime = {{ bantime }}
          findtime = {{ findtime }}
          maxretry = {{ maxretry }}
          banaction = iptables-multiport
          backend = polling

          [sshd]
          enabled = true
          port = ssh
          filter = sshd
          logpath = /var/log/auth.log
          maxretry = 3
          backend = auto

          [nginx-http-auth]
          enabled = true
          filter = nginx-http-auth
          port = http,https
          logpath = /var/log/nginx/error.log
          backend = polling

          [nginx-botsearch]
          enabled = true
          filter = nginx-botsearch
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 2
          backend = polling

          [nginx-badbots]
          enabled = true
          filter = nginx-badbots
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 2
          backend = polling

          [nginx-noscript]
          enabled = true
          filter = nginx-noscript
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 2
          backend = polling

          [nginx-req-limit]
          enabled = true
          filter = nginx-req-limit
          port = http,https
          logpath = /var/log/nginx/error.log
          maxretry = 10
          backend = polling

          [nginx-pathtraversal]
          enabled = true
          filter = nginx-pathtraversal
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 1
          bantime = 604800
          backend = polling

          [nginx-sensitive-files]
          enabled = true
          filter = nginx-botsearch
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 2
          bantime = 259200
          backend = polling

          [nginx-postflood]
          enabled = true
          filter = nginx-postflood
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 10
          findtime = 60
          bantime = 86400
          backend = polling

          [nginx-sqli]
          enabled = true
          filter = nginx-sqli
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 1
          bantime = 604800
          backend = polling

          [nginx-probe]
          enabled = true
          filter = nginx-probe
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 2
          bantime = 86400
          backend = polling

          [nginx-login]
          enabled = true
          filter = nginx-login
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 5
          findtime = 300
          bantime = 86400
          backend = polling
        dest: /etc/fail2ban/jail.local
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Create filter - path traversal attacks
      copy:
        content: |
          [Definition]
          failregex = ^<HOST> .* "(GET|POST) .*(\.\./|%%2e%%2e).*" (400|403|404|499)
                      ^<HOST> .* "(GET|POST) .*/cgi-bin/.*" (400|403|404|499)
                      ^<HOST> .* "(GET|POST) .*/bin/sh.*" (400|403|404|499)
          ignoreregex =
        dest: /etc/fail2ban/filter.d/nginx-pathtraversal.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Create filter - PHP/WordPress attacks
      copy:
        content: |
          [Definition]
          failregex = ^<HOST> .* "(GET|POST) .*\.php.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/wp-admin.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/wp-login.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/wp-content.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/xmlrpc\.php.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/wordpress.*" (400|403|404|499|504)
          ignoreregex =
        dest: /etc/fail2ban/filter.d/nginx-noscript.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Create filter - sensitive file access
      copy:
        content: |
          [Definition]
          failregex = ^<HOST> .* "(GET|POST) .*/\.env.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/\.git.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/\.htaccess.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/\.htpasswd.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/config\.php.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/admin/config.*" (400|403|404|499|504)
          ignoreregex =
        dest: /etc/fail2ban/filter.d/nginx-botsearch.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Create filter - malicious bots
      copy:
        content: |
          [Definition]
          failregex = ^<HOST> .* ".*" \d+ \d+ ".*" "(curl|wget|nikto|sqlmap|nmap|masscan|zgrab|Assetnote|l9scan|xfa1|python-requests).*"
                      ^<HOST> .* ".*" \d+ \d+ "-" "-"$
                      ^<HOST> .* ".*" \d+ \d+ "-" ""$
          ignoreregex =
        dest: /etc/fail2ban/filter.d/nginx-badbots.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Create filter - rate limit
      copy:
        content: |
          [Definition]
          failregex = limiting requests, excess:.* by zone.*client: <HOST>
          ignoreregex =
        dest: /etc/fail2ban/filter.d/nginx-req-limit.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Create filter - POST flood
      copy:
        content: |
          [Definition]
          failregex = ^<HOST> .* "POST / HTTP.*" (499|500|502|503|504) .* "-" ".*"$
                      ^<HOST> .* "POST / HTTP.*" [0-9]+ [0-9]+ "-" "Mozilla.*"$
          ignoreregex =
        dest: /etc/fail2ban/filter.d/nginx-postflood.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Create filter - SQL injection
      copy:
        content: |
          [Definition]
          failregex = ^<HOST> .* "(GET|POST) .*(union.*select|select.*from|insert.*into|delete.*from|drop.*table|or.*1.*=.*1|and.*1.*=.*1).*" (400|403|404|499|500)
          ignoreregex =
        dest: /etc/fail2ban/filter.d/nginx-sqli.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Create filter - HTTP probes
      copy:
        content: |
          [Definition]
          failregex = ^<HOST> .* "(TRACE|CONNECT|OPTIONS|PROPFIND|PATCH) .*" (400|403|404|405|499)
                      ^<HOST> .* "[A-Z]{3,10} /.*" 405
          ignoreregex =
        dest: /etc/fail2ban/filter.d/nginx-probe.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Create filter - login brute force
      copy:
        content: |
          [Definition]
          failregex = ^<HOST> .* "POST .*/login.*" (401|403|429)
                      ^<HOST> .* "POST .*/auth.*" (401|403|429)
                      ^<HOST> .* "POST .*/api/auth.*" (401|403|429)
                      ^<HOST> .* "POST .*/signin.*" (401|403|429)
          ignoreregex =
        dest: /etc/fail2ban/filter.d/nginx-login.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Enable and start fail2ban
      systemd:
        name: fail2ban
        enabled: yes
        state: started

    - name: Display summary
      debug:
        msg: |
          ====================================
          Fail2Ban Security Configured!
          ====================================

          12 Jails Ativos:
          - sshd (maxretry=3)
          - nginx-pathtraversal (ban 7 dias)
          - nginx-sqli (ban 7 dias)
          - nginx-noscript
          - nginx-botsearch
          - nginx-badbots
          - nginx-postflood
          - nginx-probe
          - nginx-login
          - nginx-sensitive-files
          - nginx-req-limit
          - nginx-http-auth

          Comandos uteis:
          - sudo fail2ban-client status
          - sudo fail2ban-client status <jail>
          - sudo fail2ban-client set <jail> unbanip <IP>
          ====================================

  handlers:
    - name: Restart fail2ban
      systemd:
        name: fail2ban
        state: restarted
