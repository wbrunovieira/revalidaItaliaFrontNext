---
# =============================================================================
# Security - Fail2Ban Auto-Protection
# =============================================================================
# Este playbook instala e configura fail2ban para bloquear automaticamente
# IPs que tentam atacar o servidor baseado em padrões nos logs do nginx.
#
# Uso:
#   ansible-playbook -i inventory_frontend.yml security-fail2ban.yml
# =============================================================================

- name: Install and Configure Fail2Ban Security
  hosts: frontend
  become: true

  vars:
    # Tempo de ban em segundos (24 horas)
    bantime: 86400
    # Janela de tempo para detectar ataques (10 minutos)
    findtime: 600
    # Número de tentativas antes de banir
    maxretry: 3

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install fail2ban
      apt:
        name: fail2ban
        state: present

    - name: Create fail2ban jail.local configuration
      copy:
        content: |
          # Fail2Ban Local Configuration
          # Generated by Ansible

          [DEFAULT]
          # Ban duration: 24 hours
          bantime = {{ bantime }}
          # Time window for detection: 10 minutes
          findtime = {{ findtime }}
          # Max retries before ban
          maxretry = {{ maxretry }}
          # Ban action using iptables
          banaction = iptables-multiport
          # Email alerts (optional)
          destemail = root@localhost
          sender = fail2ban@portalrevalida.com
          # Action to take
          action = %(action_)s

          [sshd]
          enabled = true
          port = ssh
          filter = sshd
          logpath = /var/log/auth.log
          maxretry = 5

          [nginx-http-auth]
          enabled = true
          filter = nginx-http-auth
          port = http,https
          logpath = /var/log/nginx/error.log

          [nginx-botsearch]
          enabled = true
          filter = nginx-botsearch
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 2

          [nginx-badbots]
          enabled = true
          filter = nginx-badbots
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 2

          [nginx-noscript]
          enabled = true
          filter = nginx-noscript
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 2

          [nginx-req-limit]
          enabled = true
          filter = nginx-req-limit
          port = http,https
          logpath = /var/log/nginx/error.log
          maxretry = 10
        dest: /etc/fail2ban/jail.local
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Create custom filter for path traversal attacks
      copy:
        content: |
          # Fail2Ban filter for path traversal attacks
          # Detects attempts to access /../ or encoded variants

          [Definition]
          failregex = ^<HOST> .* "(GET|POST) .*(\.\.\/|%2e%2e|\.%2e|%2e\.).*" (400|403|404|499)
                      ^<HOST> .* "(GET|POST) .*/cgi-bin/.*" (400|403|404|499)
                      ^<HOST> .* "(GET|POST) .*/bin/sh.*" (400|403|404|499)
          ignoreregex =
        dest: /etc/fail2ban/filter.d/nginx-pathtraversal.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Create custom filter for PHP/WordPress attacks
      copy:
        content: |
          # Fail2Ban filter for PHP/WordPress scanner attacks
          # Blocks bots looking for PHP vulnerabilities

          [Definition]
          failregex = ^<HOST> .* "(GET|POST) .*\.php.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/wp-admin.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/wp-login.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/wp-content.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/xmlrpc\.php.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/wordpress.*" (400|403|404|499|504)
          ignoreregex =
        dest: /etc/fail2ban/filter.d/nginx-noscript.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Create custom filter for sensitive file access
      copy:
        content: |
          # Fail2Ban filter for sensitive file access attempts
          # Blocks bots trying to access .env, .git, etc

          [Definition]
          failregex = ^<HOST> .* "(GET|POST) .*/\.env.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/\.git.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/\.htaccess.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/\.htpasswd.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/config\.php.*" (400|403|404|499|504)
                      ^<HOST> .* "(GET|POST) .*/admin/config.*" (400|403|404|499|504)
          ignoreregex =
        dest: /etc/fail2ban/filter.d/nginx-botsearch.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Create custom filter for malicious bots
      copy:
        content: |
          # Fail2Ban filter for known malicious bot user agents
          # Blocks scanners and vulnerability testers

          [Definition]
          failregex = ^<HOST> .* ".*" \d+ \d+ ".*" "(curl|wget|nikto|sqlmap|nmap|masscan|zgrab|Assetnote|l9scan|xfa1|python-requests).*"
                      ^<HOST> .* ".*" \d+ \d+ "-" "-"$
                      ^<HOST> .* ".*" \d+ \d+ "-" ""$
          ignoreregex =
        dest: /etc/fail2ban/filter.d/nginx-badbots.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

    - name: Add custom jails to jail.local
      blockinfile:
        path: /etc/fail2ban/jail.local
        marker: "# {mark} ANSIBLE CUSTOM JAILS"
        block: |

          [nginx-pathtraversal]
          enabled = true
          filter = nginx-pathtraversal
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 1
          bantime = 604800

          [nginx-sensitive-files]
          enabled = true
          filter = nginx-botsearch
          port = http,https
          logpath = /var/log/nginx/access.log
          maxretry = 2
          bantime = 259200
      notify: Restart fail2ban

    - name: Enable and start fail2ban
      systemd:
        name: fail2ban
        enabled: yes
        state: started

    - name: Wait for fail2ban to initialize
      pause:
        seconds: 5

    - name: Check fail2ban status
      command: fail2ban-client status
      register: fail2ban_status
      changed_when: false

    - name: Show fail2ban status
      debug:
        var: fail2ban_status.stdout_lines

    - name: Add new malicious IPs to blocked list (from today's attacks)
      blockinfile:
        path: /etc/nginx/security/blocked-ips.conf
        marker: "# {mark} ANSIBLE NEW BLOCKS {{ ansible_date_time.date }}"
        block: |
          # New IPs detected on {{ ansible_date_time.date }}
          # Path traversal attacks
          deny 43.142.87.72;
          # PHP/Git scanners
          deny 91.232.238.112;
          deny 94.26.88.18;
          deny 35.200.215.192;
          # LeakIX scanner
          deny 165.22.34.189;
          # curl bot
          deny 178.128.235.191;
      notify: Reload Nginx

    - name: Display summary
      debug:
        msg: |
          ====================================
          Fail2Ban Security Configured!
          ====================================

          Active Jails:
          - sshd: Protege SSH contra brute force
          - nginx-pathtraversal: Bloqueia path traversal (ban 7 dias)
          - nginx-noscript: Bloqueia ataques PHP/WordPress
          - nginx-botsearch: Bloqueia acesso a .env/.git
          - nginx-badbots: Bloqueia scanners maliciosos
          - nginx-req-limit: Bloqueia rate limit abuse

          Configuracoes:
          - Ban padrao: 24 horas
          - Path traversal: 7 dias
          - Sensitive files: 3 dias

          Comandos uteis:
          - sudo fail2ban-client status
          - sudo fail2ban-client status nginx-pathtraversal
          - sudo fail2ban-client set nginx-pathtraversal unbanip <IP>

          IPs sao automaticamente banidos ao tentar ataques!
          ====================================

  handlers:
    - name: Restart fail2ban
      systemd:
        name: fail2ban
        state: restarted

    - name: Reload Nginx
      systemd:
        name: nginx
        state: reloaded
