'use client';

import { useState, useEffect } from 'react';
import { useTranslations } from 'next-intl';
import { useToast } from '@/hooks/use-toast';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Label } from '@/components/ui/label';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { AlertTriangle, Send, X } from 'lucide-react';

export type ReportReason = 
  | 'INAPPROPRIATE_CONTENT'
  | 'SPAM'
  | 'OFFENSIVE_LANGUAGE'
  | 'HARASSMENT'
  | 'OTHER';

interface ReportModalProps {
  isOpen: boolean;
  onClose: () => void;
  itemId: string; // ID do post ou coment√°rio
  itemType: 'post' | 'comment';
  itemTitle?: string; // T√≠tulo do post ou preview do coment√°rio
  onSuccess?: () => void;
}

export default function ReportModal({
  isOpen,
  onClose,
  itemId,
  itemType,
  itemTitle,
  onSuccess,
}: ReportModalProps) {
  const t = useTranslations('Community');
  const { toast } = useToast();
  const [reason, setReason] = useState<ReportReason>('INAPPROPRIATE_CONTENT');
  const [description, setDescription] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Log quando o modal muda de estado
  useEffect(() => {
    if (isOpen) {
      console.log('üé≠ ========== MODAL DE DEN√öNCIA ABERTO ==========');
      console.log(`üìù Tipo: ${itemType.toUpperCase()}`);
      console.log(`üÜî ID: ${itemId}`);
      console.log(`üìÑ Preview: ${itemTitle ? itemTitle.substring(0, 50) + '...' : 'Sem t√≠tulo'}`);
      console.log('üïê Aberto em:', new Date().toISOString());
      console.log('================================================');
    } else {
      console.log('üé≠ Modal de den√∫ncia fechado');
    }
  }, [isOpen, itemId, itemType, itemTitle]);

  const handleSubmit = async () => {
    // Validate OTHER reason requires description
    if (reason === 'OTHER' && !description.trim()) {
      toast({
        title: t('report.error'),
        description: t('report.otherDescriptionRequired'),
        variant: 'destructive',
      });
      return;
    }

    // Validate description length
    if (description.length > 500) {
      toast({
        title: t('report.error'),
        description: t('report.descriptionTooLong'),
        variant: 'destructive',
      });
      return;
    }

    try {
      setIsSubmitting(true);
      console.log(`üìù Iniciando den√∫ncia do ${itemType}:`, { 
        itemId, 
        itemType,
        reason, 
        hasDescription: !!description,
        descriptionLength: description.length 
      });

      const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3333';
      const token = document.cookie
        .split('; ')
        .find(row => row.startsWith('token='))
        ?.split('=')[1];

      if (!token) {
        console.error('‚ùå Token n√£o encontrado nos cookies');
        throw new Error(t('report.authRequired'));
      }

      const reportPayload = {
        reason,
        description: description.trim() || undefined,
      };

      const endpoint = itemType === 'post' 
        ? `${apiUrl}/api/v1/community/posts/${itemId}/reports`
        : `${apiUrl}/api/v1/community/comments/${itemId}/reports`;

      // Log detalhado ANTES da requisi√ß√£o
      console.log('üöÄ ========== INICIANDO DEN√öNCIA ==========');
      console.log(`üìù Tipo de item: ${itemType.toUpperCase()}`);
      console.log(`üÜî ID do ${itemType}: ${itemId}`);
      console.log(`üìç Endpoint: ${endpoint}`);
      console.log('üì¶ Payload da requisi√ß√£o:', {
        reason,
        description: description || '(vazio)',
        descriptionLength: description.length
      });
      console.log(`üîë Token presente: ${!!token ? 'SIM' : 'N√ÉO'}`);
      console.log(`üîë Token (primeiros 20 chars): ${token ? token.substring(0, 20) + '...' : 'N/A'}`);
      console.log('üïê Timestamp:', new Date().toISOString());
      console.log('==========================================');

      const response = await fetch(
        endpoint,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(reportPayload),
        }
      );

      // Log detalhado da RESPOSTA
      console.log('üì• ========== RESPOSTA DA API ==========');
      console.log(`üìä Status HTTP: ${response.status} - ${response.statusText}`);
      console.log(`‚úÖ Sucesso: ${response.ok ? 'SIM' : 'N√ÉO'}`);
      console.log('üìã Headers da resposta:', {
        contentType: response.headers.get('content-type'),
        contentLength: response.headers.get('content-length'),
        date: response.headers.get('date'),
        server: response.headers.get('server')
      });

      let data;
      try {
        const responseText = await response.text();
        console.log('üìÑ Resposta bruta (texto):', responseText);
        console.log(`üìè Tamanho da resposta: ${responseText.length} caracteres`);
        
        if (responseText) {
          data = JSON.parse(responseText);
          console.log('‚úÖ Parse JSON bem-sucedido');
        } else {
          data = {};
          console.warn('‚ö†Ô∏è Resposta vazia do servidor');
        }
      } catch (parseError) {
        console.error('‚ùå Erro ao fazer parse da resposta:', parseError);
        data = { message: 'Erro ao processar resposta do servidor' };
      }

      console.log('üì® Dados da resposta processados:', JSON.stringify(data, null, 2));
      console.log('üïê Timestamp da resposta:', new Date().toISOString());
      console.log('==========================================');

      if (!response.ok) {
        // Log detalhado de ERRO
        console.log('‚ùå ========== ERRO NA DEN√öNCIA ==========');
        console.log(`üö® C√≥digo de erro: ${response.status}`);
        console.log(`üìù Tipo de erro: ${response.statusText}`);
        console.log('üìä Detalhes do erro:', {
          message: data?.message || 'Sem mensagem de erro',
          error: data?.error || 'Sem detalhes adicionais',
          statusCode: data?.statusCode || response.status,
          type: data?.type || 'N√£o especificado'
        });
        console.log('==========================================');
        
        // Tratar erros espec√≠ficos com mensagens amig√°veis
        switch (response.status) {
          case 409:
            console.info('‚ÑπÔ∏è Den√∫ncia duplicada - usu√°rio j√° reportou este ' + itemType);
            toast({
              title: t('report.warning'),
              description: t('report.alreadyReported'),
              variant: 'default',
            });
            onClose(); // Fechar modal sem erro
            return; // N√£o lan√ßar erro
            
          case 404:
            console.warn('‚ö†Ô∏è Post n√£o encontrado no servidor');
            toast({
              title: t('report.error'),
              description: t('report.postNotFound'),
              variant: 'destructive',
            });
            onClose();
            return;
            
          case 400:
            console.warn('‚ö†Ô∏è Dados inv√°lidos na requisi√ß√£o:', data?.message);
            // Verificar se √© erro espec√≠fico do OTHER
            if (data?.message?.includes('OTHER reason requires')) {
              toast({
                title: t('report.error'),
                description: t('report.otherDescriptionRequired'),
                variant: 'destructive',
              });
            } else {
              toast({
                title: t('report.error'),
                description: data?.message || t('report.invalidReason'),
                variant: 'destructive',
              });
            }
            return; // N√£o fechar modal para permitir corre√ß√£o
            
          case 401:
            console.warn('‚ö†Ô∏è Usu√°rio n√£o autenticado');
            toast({
              title: t('report.error'),
              description: t('report.authRequired'),
              variant: 'destructive',
            });
            onClose();
            // Opcionalmente redirecionar para login
            setTimeout(() => {
              window.location.href = '/login';
            }, 2000);
            return;
            
          default:
            console.error('‚ùå Erro inesperado n√£o tratado:', {
              status: response.status,
              data
            });
            toast({
              title: t('report.error'),
              description: t('report.submitError'),
              variant: 'destructive',
            });
            return;
        }
      }

      // Log detalhado de SUCESSO
      console.log('‚úÖ ========== DEN√öNCIA BEM-SUCEDIDA ==========');
      console.log(`üéØ ${itemType.charAt(0).toUpperCase() + itemType.slice(1)} denunciado com sucesso!`);
      console.log('üìã Detalhes do report criado:', {
        reportId: data.report?.id || 'ID n√£o retornado',
        itemId: data.report?.postId || data.report?.commentId || itemId,
        reporterId: data.report?.reporterId || 'N√£o informado',
        reason: data.report?.reason || reason,
        status: data.report?.status || 'PENDING',
        createdAt: data.report?.createdAt || new Date().toISOString()
      });
      console.log('üïê Timestamp do sucesso:', new Date().toISOString());
      console.log('=============================================');
      
      toast({
        title: t('report.success'),
        description: t('report.successDescription'),
      });

      // Reset form
      setReason('INAPPROPRIATE_CONTENT');
      setDescription('');
      
      onSuccess?.();
      onClose();
      console.log('üîÑ Modal fechado ap√≥s sucesso');
    } catch (error) {
      // Log detalhado de ERRO DE REDE
      console.log('üî• ========== ERRO CR√çTICO ==========');
      console.log('üí• Tipo de erro: ERRO DE REDE OU EXCE√á√ÉO');
      console.log('üîç Detalhes do erro:', {
        message: error instanceof Error ? error.message : 'Erro desconhecido',
        name: error instanceof Error ? error.name : 'N/A',
        stack: error instanceof Error ? error.stack?.split('\n').slice(0, 3).join('\n') : 'N/A'
      });
      console.log(`üéØ Tentativa de denunciar: ${itemType} com ID ${itemId}`);
      console.log('üïê Timestamp do erro:', new Date().toISOString());
      console.log('=====================================');
      
      toast({
        title: t('report.error'),
        description: t('report.submitError'),
        variant: 'destructive',
      });
    } finally {
      setIsSubmitting(false);
      console.log('üîö Processo de den√∫ncia finalizado');
    }
  };

  const handleClose = () => {
    if (!isSubmitting) {
      console.log('üö™ Fechando modal de den√∫ncia');
      setReason('INAPPROPRIATE_CONTENT');
      setDescription('');
      onClose();
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={handleClose}>
      <DialogContent className="bg-gray-800 text-white border-gray-700 max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2 text-xl">
            <AlertTriangle className="text-red-400" size={24} />
            {t('report.title')}
          </DialogTitle>
          <DialogDescription asChild>
            <div className="text-gray-400">
              {itemTitle && (
                <div className="mb-2 p-2 bg-gray-700/50 rounded-lg">
                  <span className="text-xs text-gray-500">
                    {t(itemType === 'post' ? 'report.reportingPost' : 'report.reportingComment')}:
                  </span>
                  <p className="text-sm text-white mt-1 line-clamp-2">{itemTitle}</p>
                </div>
              )}
              <p className="text-sm">{t('report.description')}</p>
            </div>
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 mt-4">
          <div className="space-y-3">
            <Label className="text-white">{t('report.reasonLabel')}</Label>
            <RadioGroup
              value={reason}
              onValueChange={(value: string) => setReason(value as ReportReason)}
              disabled={isSubmitting}
            >
              <div className="flex items-center space-x-2 p-2 hover:bg-gray-700/50 rounded-lg">
                <RadioGroupItem value="INAPPROPRIATE_CONTENT" id="r1" />
                <Label htmlFor="r1" className="cursor-pointer flex-1">
                  <div>
                    <p className="text-white">{t('report.reasons.inappropriate')}</p>
                    <p className="text-xs text-gray-400">{t('report.reasons.inappropriateDesc')}</p>
                  </div>
                </Label>
              </div>
              
              <div className="flex items-center space-x-2 p-2 hover:bg-gray-700/50 rounded-lg">
                <RadioGroupItem value="SPAM" id="r2" />
                <Label htmlFor="r2" className="cursor-pointer flex-1">
                  <div>
                    <p className="text-white">{t('report.reasons.spam')}</p>
                    <p className="text-xs text-gray-400">{t('report.reasons.spamDesc')}</p>
                  </div>
                </Label>
              </div>
              
              <div className="flex items-center space-x-2 p-2 hover:bg-gray-700/50 rounded-lg">
                <RadioGroupItem value="OFFENSIVE_LANGUAGE" id="r3" />
                <Label htmlFor="r3" className="cursor-pointer flex-1">
                  <div>
                    <p className="text-white">{t('report.reasons.offensive')}</p>
                    <p className="text-xs text-gray-400">{t('report.reasons.offensiveDesc')}</p>
                  </div>
                </Label>
              </div>
              
              <div className="flex items-center space-x-2 p-2 hover:bg-gray-700/50 rounded-lg">
                <RadioGroupItem value="HARASSMENT" id="r4" />
                <Label htmlFor="r4" className="cursor-pointer flex-1">
                  <div>
                    <p className="text-white">{t('report.reasons.harassment')}</p>
                    <p className="text-xs text-gray-400">{t('report.reasons.harassmentDesc')}</p>
                  </div>
                </Label>
              </div>
              
              <div className="flex items-center space-x-2 p-2 hover:bg-gray-700/50 rounded-lg">
                <RadioGroupItem value="OTHER" id="r5" />
                <Label htmlFor="r5" className="cursor-pointer flex-1">
                  <div>
                    <p className="text-white">{t('report.reasons.other')}</p>
                    <p className="text-xs text-gray-400">{t('report.reasons.otherDesc')}</p>
                  </div>
                </Label>
              </div>
            </RadioGroup>
          </div>

          <div className="space-y-2">
            <Label htmlFor="description" className="text-white">
              {t('report.detailsLabel')} 
              {reason === 'OTHER' && <span className="text-red-400 ml-1">*</span>}
            </Label>
            <Textarea
              id="description"
              placeholder={t('report.detailsPlaceholder')}
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              disabled={isSubmitting}
              className="bg-gray-700 border-gray-600 text-white placeholder-gray-400 min-h-[100px] resize-none"
              maxLength={500}
            />
            <p className="text-xs text-gray-400 text-right">
              {description.length}/500
            </p>
          </div>

          <div className="flex gap-2 pt-4">
            <Button
              onClick={handleClose}
              variant="outline"
              disabled={isSubmitting}
              className="flex-1 bg-gray-700 hover:bg-gray-600 border-gray-600 text-white"
            >
              <X size={16} className="mr-2" />
              {t('report.cancel')}
            </Button>
            <Button
              onClick={handleSubmit}
              disabled={isSubmitting || (reason === 'OTHER' && !description.trim())}
              className="flex-1 bg-red-600 hover:bg-red-700 text-white"
            >
              {isSubmitting ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2" />
                  {t('report.submitting')}
                </>
              ) : (
                <>
                  <Send size={16} className="mr-2" />
                  {t('report.submit')}
                </>
              )}
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}